#!/usr/bin/env bash

FILE_PATH="${1}"
FILE_EXTENSION="${FILE_PATH##*.}"
FILE_EXTENSION_LOWER="$(printf "%s" "${FILE_EXTENSION}" | tr '[:upper:]' '[:lower:]')"

PV_WIDTH="${2}"
PV_HEIGHT="${3}"
HORIZONTAL_POS="${4}"
VERTICAL_POS="${5}"
MODE="${6}" # "preview" or "preload"

# Cache image before previewing by lf's preload feature
# Reference: https://github.com/gokcehan/lf/pull/2206
CACHE_DIR=$HOME/.cache/lf

cache() {
    local hash
    hash=$(gstat --printf '%n\0%i\0%Y' "$1" | sha256sum | cut -d' ' -f1)
    echo "$CACHE_DIR/$hash.jpg"
}

preload() {
    mkdir -p "$CACHE_DIR"
    ffmpeg -i "$1" -vframes 1 "$(cache "${2:-$1}")"
}

bat() {
    command bat \
        --color=always --paging=never \
        --style=plain \
        --wrap=character \
        --line-range :"${PV_HEIGHT}" \
        --terminal-width="${PV_WIDTH}" "$@"
}

image_previewer() {
    # kitty's icat doesn't work well in tmux: images can be displayed but not be cleared, see
    # https://github.com/kovidgoyal/kitty/commit/6347ea0210ac9dd913bfc540f5f46489fbc27a77.
    # In neovim's builtin terminal, I cannot find an approach to preview images.
    if [[ ! $TERM =~ "tmux" && -z $NVIM ]]; then
        if [[ $KITTY_WINDOW_ID || $GHOSTTY_BIN_DIR ]]; then
            local place="${PV_WIDTH}x${PV_HEIGHT}@${HORIZONTAL_POS}x${VERTICAL_POS}"
            kitty icat --clear --transfer-mode memory --stdin no --align left --place "$place" "$1" < /dev/null > /dev/tty
        elif [[ $WEZTERM_PANE || $ALACRITTY_WINDOW_ID ]]; then
            chafa -s "${PV_WIDTH}x${PV_HEIGHT}" --animate off --polite on "$1"
        else
            printf "Image preview is not supported"
        fi
    else
        printf "Image preview is not supported"
    fi
}

handle_extension() {
    case "${FILE_EXTENSION_LOWER}" in
        # Markdown
        md)
            glow -s dark --width "${PV_WIDTH}" -- "${FILE_PATH}" && exit 0;;
        # Archive
        bz2|gz|lz|tar|xz|zip)
            atool --list -- "${FILE_PATH}" && exit 0;;
        rar)
            unrar lt -p- -- "${FILE_PATH}" && exit 0;;
        7z)
            7z l -p -- "${FILE_PATH}" && exit 0;;
        # PDF
        pdf)
            pdftotext -l 10 -nopgbrk -q -- "${FILE_PATH}" - | fmt -w "${PV_WIDTH}" && exit 0;;
        # OpenDocument
        odt|sxw|ods|odp)
            odt2txt "${FILE_PATH}" && exit 0;;
        # XLSX
        xlsx)
            xlsx2csv -- "${FILE_PATH}" | head -n 500 && exit 0;;
        # JSON
        json)
            jq --color-output . "${FILE_PATH}" && exit 0;;
        # BitTorrent
        torrent)
            transmission-show -- "${FILE_PATH}" && exit 0;;
        # Dmg
        dmg)
            hdiutil imageinfo "${FILE_PATH}" | bat -l yaml && exit 0;;
        # CSV and TSV
        csv|tsv)
            mlr --icsv --opprint -C --key-color darkcyan --value-color grey70 head -n 500 "${FILE_PATH}" && exit 0;;
        # Sqlite3 and sqlite
        sqlite3 | sqlite)
            sqlite3 "${FILE_PATH}" .schema | sed "s/;/;\n/g" | bat -l sql && exit 0;;
        # so and dylib
        so|dylib)
            nm "${FILE_PATH}" && exit 0
            nm -D "${FILE_PATH}" && exit 0
    esac
}

handle_mime() {
    local mimetype="${1}"
    case "${mimetype}" in
        # DOCX, ePub, FB2
        *wordprocessingml.document|*/epub+zip|*/x-fictionbook+xml)
            pandoc -s -t markdown -- "${FILE_PATH}" | glow -s dark --width "${PV_WIDTH}" && exit 0;;
        # Image
        image/*)
            if [[ $MODE == "preload" ]]; then
                preload "$FILE_PATH"
                exit 1
            else
                image_previewer "$(cache "$FILE_PATH")"
                exit 0
            fi
            ;;
        # Video
        video/*)
            if [[ $MODE == "preload" ]]; then
                local thumbnail
                thumbnail=$("$XDG_CONFIG_HOME"/lf/vidthumb "${FILE_PATH}")
                preload "$thumbnail" "$FILE_PATH"
                exit 1
            else
                image_previewer "$(cache "$FILE_PATH")"
                exit 0
            fi
            ;;
        # Text
        text/* | */xml)
            (bat --style=numbers,changes -- "${FILE_PATH}" \
            || highlight --out-format truecolor --style darkplus --force \
                    --line-numbers --line-range=1-"${PV_HEIGHT}" -- "${FILE_PATH}" \
            || cat -- "${FILE_PATH}") && exit 0;;
    esac
}

handle_fallback() {
    # Use file command as the fallback. It outputs the file properties, separated by comma, in a
    # single lone line. In order to fit the width of the preview window, replace each comma with a
    # line break, but leave the commas inside square brackets unchanged.
    file --dereference --brief -- "${FILE_PATH}" | gsed -r ':a; s/(\[[^][]*),([^][]*\])/\1TTEEMMPP\2/g; ta; s/, /\n/g; s/TTEEMMPP/,/g' && exit 0
    exit 0
}

MIMETYPE="$( file --dereference --brief --mime-type -- "${FILE_PATH}" )"
handle_extension
handle_mime "${MIMETYPE}"
handle_fallback
